<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dYdX ‰∫§ÊòìÈù¢Êùø</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e27;
      color: #e0e6ed;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #5f67e8;
      font-size: 32px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: #151932;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #252a47;
    }

    .panel h2 {
      margin-bottom: 15px;
      color: #818cf8;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #9ca3af;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      background: #0a0e27;
      border: 1px solid #252a47;
      border-radius: 6px;
      color: #e0e6ed;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #5f67e8;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-buy {
      background: #10b981;
      color: white;
    }

    .btn-buy:hover {
      background: #059669;
    }

    .btn-sell {
      background: #ef4444;
      color: white;
    }

    .btn-sell:hover {
      background: #dc2626;
    }

    .btn-refresh {
      background: #5f67e8;
      color: white;
      margin-bottom: 15px;
    }

    .btn-refresh:hover {
      background: #4c53d5;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .position-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .stat-card {
      background: #0a0e27;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #252a47;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-value.positive {
      color: #10b981;
    }

    .stat-value.negative {
      color: #ef4444;
    }

    .log {
      background: #0a0e27;
      border: 1px solid #252a47;
      border-radius: 8px;
      padding: 15px;
      height: 150px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #9ca3af;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 3px 0;
      border-bottom: 1px solid #1a1f3a;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #6366f1;
    }

    .log-success {
      color: #10b981;
    }

    .log-error {
      color: #ef4444;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* ‰∫§ÊòìÂéÜÂè≤Ë°®Ê†º */
    .trade-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .trade-table th {
      background: #0a0e27;
      padding: 12px 8px;
      text-align: left;
      color: #9ca3af;
      font-weight: 600;
      border-bottom: 2px solid #252a47;
    }

    .trade-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #1a1f3a;
    }

    .trade-table tr:hover {
      background: #0a0e27;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-long {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .badge-short {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .badge-open {
      background: rgba(95, 103, 232, 0.2);
      color: #818cf8;
    }

    .badge-closed {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .no-data {
      text-align: center;
      color: #9ca3af;
      padding: 40px 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ dYdX ‰∫§ÊòìÈù¢Êùø</h1>

    <div class="grid">
      <!-- ÊåÅ‰ªì‰ø°ÊÅØ -->
      <div class="panel">
        <h2>üìä Ê¥ªË∑ÉÊåÅ‰ªì</h2>
        <button class="btn-refresh" onclick="refreshPosition()">Âà∑Êñ∞ÊåÅ‰ªì</button>
        <div id="positions-container" style="margin-top: 15px;">
          <div style="text-align: center; color: #9ca3af; padding: 20px;">
            Âä†ËΩΩ‰∏≠...
          </div>
        </div>
      </div>

      <!-- Â∏Ç‰ª∑Âçï -->
      <div class="panel">
        <h2>‚ö° Â∏Ç‰ª∑Âçï</h2>
        <div class="form-group">
          <label>Â∏ÇÂú∫</label>
          <select id="market-market">
            <option value="ETH-USD">ETH-USD</option>
            <option value="BTC-USD">BTC-USD</option>
            <option value="SOL-USD">SOL-USD</option>
          </select>
        </div>
        <div class="form-group">
          <label>Êï∞Èáè</label>
          <input type="number" id="market-size" placeholder="0.01" step="0.001" value="0.01">
        </div>
        <div class="btn-group">
          <button class="btn-buy" onclick="marketOrder('BUY')">‰π∞ÂÖ•</button>
          <button class="btn-sell" onclick="marketOrder('SELL')">ÂçñÂá∫</button>
        </div>
      </div>

      <!-- Èôê‰ª∑Âçï -->
      <div class="panel">
        <h2>üìù Èôê‰ª∑Âçï</h2>
        <div class="form-group">
          <label>Â∏ÇÂú∫</label>
          <select id="limit-market">
            <option value="ETH-USD">ETH-USD</option>
            <option value="BTC-USD">BTC-USD</option>
            <option value="SOL-USD">SOL-USD</option>
          </select>
        </div>
        <div class="form-group">
          <label>‰ª∑Ê†º (USD)</label>
          <input type="number" id="limit-price" placeholder="2315.50" step="0.01">
        </div>
        <div class="form-group">
          <label>Êï∞Èáè</label>
          <input type="number" id="limit-size" placeholder="0.01" step="0.001" value="0.01">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="limit-postonly" checked>
            Maker Only (‰ªÖÊåÇÂçï)
          </label>
        </div>
        <div class="btn-group">
          <button class="btn-buy" onclick="limitOrder('BUY')">Èôê‰ª∑‰π∞</button>
          <button class="btn-sell" onclick="limitOrder('SELL')">Èôê‰ª∑Âçñ</button>
        </div>
      </div>

      <!-- Êìç‰ΩúÊó•Âøó -->
      <div class="panel">
        <h2>üìú Êìç‰ΩúÊó•Âøó</h2>
        <div class="log" id="log"></div>
      </div>
    </div>

    <!-- Ëá™Âä®‰∫§ÊòìÂéÜÂè≤ -->
    <div class="panel" style="margin-top: 20px;">
      <h2>ü§ñ Ëá™Âä®‰∫§ÊòìÂéÜÂè≤</h2>
      <button class="btn-refresh" onclick="refreshTradeHistory()">Âà∑Êñ∞ÂéÜÂè≤</button>
      <div id="trade-history" style="margin-top: 15px;">
        <div style="text-align: center; color: #9ca3af; padding: 20px;">
          Âä†ËΩΩ‰∏≠...
        </div>
      </div>
    </div>
  </div>

  <script>
    let isLoading = false;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : '';
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${className}">${message}</span>`;
      
      logDiv.insertBefore(entry, logDiv.firstChild);
      
      // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }

    async function refreshPosition() {
      if (isLoading) return;
      
      try {
        isLoading = true;
        document.body.classList.add('loading');
        
        const response = await fetch('/api/trade-history');
        const data = await response.json();
        
        if (data.success) {
          const container = document.getElementById('positions-container');
          
          // Á≠õÈÄâÊ¥ªË∑ÉÊåÅ‰ªì
          const activePositions = data.trades.filter(t => t.status === 'OPEN');
          
          if (activePositions.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">ÊöÇÊó†ÊåÅ‰ªì</div>';
          } else {
            let html = '<div style="display: grid; gap: 10px;">';
            
            activePositions.forEach(pos => {
              const sideBadge = pos.side === 'LONG' 
                ? '<span class="badge badge-long">ÂÅöÂ§ö</span>'
                : '<span class="badge badge-short">ÂÅöÁ©∫</span>';
              
              const value = pos.size * pos.entryPrice;
              const hoursHeld = ((new Date() - new Date(pos.openedAt)) / (1000 * 60 * 60)).toFixed(1);
              
              html += `
                <div class="stat-card">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                      <strong style="font-size: 18px; color: #e0e6ed;">${pos.ticker}</strong>
                      ${sideBadge}
                    </div>
                    <div style="text-align: right; color: #9ca3af; font-size: 12px;">
                      ÊåÅ‰ªì ${hoursHeld}h
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                    <div>
                      <div style="color: #9ca3af;">Êï∞Èáè</div>
                      <div style="color: #e0e6ed;">${pos.size.toFixed(4)}</div>
                    </div>
                    <div>
                      <div style="color: #9ca3af;">ÂºÄ‰ªì‰ª∑</div>
                      <div style="color: #e0e6ed;">$${pos.entryPrice.toFixed(2)}</div>
                    </div>
                    <div>
                      <div style="color: #9ca3af;">‰ª∑ÂÄº</div>
                      <div style="color: #e0e6ed;">$${value.toFixed(2)}</div>
                    </div>
                    <div>
                      <div style="color: #9ca3af;">Áõà‰∫è</div>
                      <div class="${(pos.pnl || 0) >= 0 ? 'positive' : 'negative'}">
                        ${(pos.pnl || 0) >= 0 ? '+' : ''}$${(pos.pnl || 0).toFixed(2)}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            container.innerHTML = html;
          }
          
          log('ÊåÅ‰ªìÂà∑Êñ∞ÊàêÂäü', 'success');
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log(`Âà∑Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
      } finally {
        isLoading = false;
        document.body.classList.remove('loading');
      }
    }

    async function marketOrder(side) {
      if (isLoading) return;
      
      const market = document.getElementById('market-market').value;
      const size = parseFloat(document.getElementById('market-size').value);
      
      if (!size || size <= 0) {
        log('ËØ∑ËæìÂÖ•ÊúâÊïàÊï∞Èáè', 'error');
        return;
      }
      
      try {
        isLoading = true;
        document.body.classList.add('loading');
        
        log(`Êèê‰∫§Â∏Ç‰ª∑Âçï: ${side} ${size} ${market}...`);
        
        const response = await fetch('/api/market-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ market, side, size })
        });
        
        const data = await response.json();
        
        if (data.success) {
          log(`‚úÖ Â∏Ç‰ª∑ÂçïÂ∑≤Êèê‰∫§ (ID: ${data.clientId})`, 'success');
          setTimeout(refreshPosition, 3000); // 3ÁßíÂêéÂà∑Êñ∞ÊåÅ‰ªì
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log(`Â∏Ç‰ª∑ÂçïÂ§±Ë¥•: ${error.message}`, 'error');
      } finally {
        isLoading = false;
        document.body.classList.remove('loading');
      }
    }

    async function limitOrder(side) {
      if (isLoading) return;
      
      const market = document.getElementById('limit-market').value;
      const price = parseFloat(document.getElementById('limit-price').value);
      const size = parseFloat(document.getElementById('limit-size').value);
      const postOnly = document.getElementById('limit-postonly').checked;
      
      if (!price || price <= 0) {
        log('ËØ∑ËæìÂÖ•ÊúâÊïà‰ª∑Ê†º', 'error');
        return;
      }
      
      if (!size || size <= 0) {
        log('ËØ∑ËæìÂÖ•ÊúâÊïàÊï∞Èáè', 'error');
        return;
      }
      
      try {
        isLoading = true;
        document.body.classList.add('loading');
        
        log(`Êèê‰∫§Èôê‰ª∑Âçï: ${side} ${size} ${market} @ $${price} (Maker: ${postOnly})...`);
        
        const response = await fetch('/api/limit-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ market, side, price, size, postOnly })
        });
        
        const data = await response.json();
        
        if (data.success) {
          log(`‚úÖ Èôê‰ª∑ÂçïÂ∑≤Êèê‰∫§ (ID: ${data.clientId})`, 'success');
          setTimeout(refreshPosition, 3000);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log(`Èôê‰ª∑ÂçïÂ§±Ë¥•: ${error.message}`, 'error');
      } finally {
        isLoading = false;
        document.body.classList.remove('loading');
      }
    }

    async function refreshTradeHistory() {
      try {
        const response = await fetch('/api/trade-history');
        const data = await response.json();
        
        const container = document.getElementById('trade-history');
        
        if (!data.success || !data.trades || data.trades.length === 0) {
          container.innerHTML = '<div class="no-data">ÊöÇÊó†‰∫§ÊòìÂéÜÂè≤</div>';
          return;
        }
        
        // ÊûÑÂª∫Ë°®Ê†º
        let html = '<table class="trade-table"><thead><tr>';
        html += '<th>Êó∂Èó¥</th>';
        html += '<th>Â∏ÅÁßç</th>';
        html += '<th>ÊñπÂêë</th>';
        html += '<th>Êï∞Èáè</th>';
        html += '<th>ÂºÄ‰ªì‰ª∑</th>';
        html += '<th>ÂΩìÂâç‰ª∑</th>';
        html += '<th>Áõà‰∫è</th>';
        html += '<th>Áä∂ÊÄÅ</th>';
        html += '</tr></thead><tbody>';
        
        data.trades.forEach(trade => {
          const time = new Date(trade.openedAt).toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const sideBadge = trade.side === 'LONG' 
            ? '<span class="badge badge-long">ÂÅöÂ§ö</span>'
            : '<span class="badge badge-short">ÂÅöÁ©∫</span>';
          
          const pnl = trade.pnl || 0;
          const pnlClass = pnl >= 0 ? 'positive' : 'negative';
          const pnlText = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
          
          const statusBadge = trade.status === 'OPEN'
            ? '<span class="badge badge-open">ÊåÅ‰ªì‰∏≠</span>'
            : '<span class="badge badge-closed">Â∑≤Âπ≥‰ªì</span>';
          
          html += '<tr>';
          html += `<td>${time}</td>`;
          html += `<td><strong>${trade.ticker}</strong></td>`;
          html += `<td>${sideBadge}</td>`;
          html += `<td>${trade.size.toFixed(4)}</td>`;
          html += `<td>$${trade.entryPrice.toFixed(2)}</td>`;
          html += `<td>$${(trade.currentPrice || trade.entryPrice).toFixed(2)}</td>`;
          html += `<td class="${pnlClass}">${pnlText}</td>`;
          html += `<td>${statusBadge}</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        log('‰∫§ÊòìÂéÜÂè≤Â∑≤Âà∑Êñ∞', 'success');
      } catch (error) {
        log(`Ëé∑Âèñ‰∫§ÊòìÂéÜÂè≤Â§±Ë¥•: ${error.message}`, 'error');
      }
    }

    // È°µÈù¢Âä†ËΩΩÊó∂Âà∑Êñ∞ÊåÅ‰ªì
    window.addEventListener('load', () => {
      log('‰∫§ÊòìÈù¢ÊùøÂ∑≤Âä†ËΩΩ', 'success');
      refreshPosition();
      refreshTradeHistory();
      
      // ÊØè30ÁßíËá™Âä®Âà∑Êñ∞ÊåÅ‰ªìÂíå‰∫§ÊòìÂéÜÂè≤
      setInterval(() => {
        refreshPosition();
        refreshTradeHistory();
      }, 30000);
    });
  </script>
</body>
</html>
